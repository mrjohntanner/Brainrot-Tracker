<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SAB Brainrot Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0b0f14;
  --panel:#0f1620;
  --panel2:#111b27;
  --text:#e8eef7;
  --muted:#8b97aa;
  --accent:#4da3ff;
  --radius:12px;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}

/* ================= HEADER ================= */

header{
  padding:14px 20px;
  background:var(--panel);
  display:flex;
  align-items:center;
  gap:14px;
}

header button{
  background:none;
  border:none;
  color:var(--muted);
  font-size:14px;
  cursor:pointer;
}
header button.active{color:var(--accent)}

header .status{
  margin-left:auto;
  font-size:12px;
  color:var(--muted);
}

/* ================= LAYOUT ================= */

main{padding:18px}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(210px,1fr));
  gap:12px;
}

/* ================= CARD ================= */

.card{
  background:var(--panel2);
  border-radius:var(--radius);
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
  position:relative;
}

/* rarity accent (NOT full background) */
.rarity-bar{
  height:4px;
  border-radius:10px;
  margin:-10px -10px 6px -10px;
}

/* image frame */
.card img{
  width:100%;
  height:96px;
  object-fit:contain;
  background:#0b0f14;
  border-radius:8px;
  padding:6px;
}

/* text */
.card .name{
  font-size:14px;
  font-weight:600;
}
.card .rarity{
  font-size:12px;
  color:var(--muted);
}

/* actions */
.card button{
  margin-top:auto;
  background:#0b0f14;
  border:1px solid rgba(255,255,255,.12);
  color:var(--text);
  border-radius:6px;
  padding:6px;
  font-size:13px;
  cursor:pointer;
}

/* ================= RARITY COLORS ================= */

.r-common{background:linear-gradient(90deg,#1e7f43,#34d399)}
.r-rare{background:linear-gradient(90deg,#1e3a8a,#3b82f6)}
.r-epic{background:linear-gradient(90deg,#4c1d95,#a855f7)}
.r-legendary{background:linear-gradient(90deg,#92400e,#facc15)}
.r-mythic{background:linear-gradient(90deg,#6d28d9,#c084fc)}
.r-brainrot-god{
  background:linear-gradient(90deg,red,orange,yellow,green,blue,indigo,violet)
}
.r-secret{background:linear-gradient(90deg,#000,#fff)}
.r-og{background:linear-gradient(90deg,#facc15,#000)}
.r-festive{background:linear-gradient(90deg,#dc2626,#16a34a)}
.r-admin{background:linear-gradient(90deg,#dc2626,#facc15)}
</style>
</head>
<body>

<header>
  <button id="tabIndex" class="active">Index</button>
  <button id="tabBases">My Bases</button>
  <button onclick="resyncWiki()">Resync Wiki</button>
  <div class="status" id="status">Loading…</div>
</header>

<main id="app"></main>

<script>
/* ================= STATE ================= */

let ALL_BRAINROTS = [];
let bases = JSON.parse(localStorage.getItem("sabBases")||"{}");
if(!Object.keys(bases).length) bases={Main:{brainrots:[]}};
Object.values(bases).forEach(b=>{
  b.brainrots=b.brainrots.map(x=>typeof x==="string"?{id:x}:x);
});

let tab="index";
let currentBase=Object.keys(bases)[0];
const app=document.getElementById("app");
const status=document.getElementById("status");

/* ================= HELPERS ================= */

function rarityClass(r){
  return "r-"+(r||"common").toLowerCase().replace(/\s+/g,"-");
}

function detectRarity(categories){
  const map=[
    "Brainrot God","Mythic","Legendary","Epic",
    "Rare","Common","Secret","OG","Festive","Admin"
  ];
  for(const key of map){
    if(categories.some(c=>c.includes(key))) return key;
  }
  return "Common";
}

/* ================= WIKI SYNC ================= */

async function resyncWiki(){
  status.textContent="Syncing wiki…";

  const res = await fetch(
    "https://stealabr.fandom.com/api.php" +
    "?action=query&list=categorymembers" +
    "&cmtitle=Category:Brainrots&cmlimit=500" +
    "&format=json&origin=*"
  );
  const pages = (await res.json()).query.categorymembers;

  ALL_BRAINROTS=[];

  for(const p of pages){
    const r = await fetch(
      "https://stealabr.fandom.com/api.php" +
      "?action=query&prop=pageimages|categories" +
      "&piprop=original&cllimit=20" +
      "&format=json&origin=*" +
      "&titles=" + encodeURIComponent(p.title)
    );
    const data = await r.json();
    const page = data.query.pages[Object.keys(data.query.pages)[0]];

    ALL_BRAINROTS.push({
      id:p.pageid,
      name:p.title,
      image:page?.original?.source || null,
      rarity:detectRarity((page.categories||[]).map(c=>c.title))
    });
  }

  localStorage.setItem("sabWikiCache",JSON.stringify(ALL_BRAINROTS));
  status.textContent="Synced from wiki";
  render();
}

/* ================= UI ================= */

tabIndex.onclick=()=>{tab="index";render()};
tabBases.onclick=()=>{tab="bases";render()};

function render(){
  document.querySelectorAll("header button")
    .forEach(b=>b.classList.remove("active"));
  document.getElementById(tab==="index"?"tabIndex":"tabBases")
    .classList.add("active");
  tab==="index"?renderIndex():renderBases();
}

function renderIndex(){
  app.innerHTML=`
    <div class="grid">
      ${ALL_BRAINROTS.map(br=>`
        <div class="card">
          <div class="rarity-bar ${rarityClass(br.rarity)}"></div>
          ${br.image?`<img src="${br.image}">`:``}
          <div class="name">${br.name}</div>
          <div class="rarity">${br.rarity}</div>
          <button onclick="addBrainrot('${br.id}')">Add</button>
        </div>
      `).join("")}
    </div>`;
}

function renderBases(){
  app.innerHTML=`<div class="grid">
    ${bases[currentBase].brainrots.map(b=>`
      <div class="card"><div class="name">${b.id}</div></div>
    `).join("")}
  </div>`;
}

function addBrainrot(id){
  bases[currentBase].brainrots.push({id});
  localStorage.setItem("sabBases",JSON.stringify(bases));
}

/* ================= INIT ================= */

const cached = localStorage.getItem("sabWikiCache");
if(cached){
  ALL_BRAINROTS=JSON.parse(cached);
  status.textContent="Loaded from cache";
  render();
}
resyncWiki();
</script>
</body>
</html>
